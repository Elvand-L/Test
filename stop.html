<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Products | Grand AC</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- GPay Loader Script -->
    <script>
        // This script runs first. It defines the function that the GPay script will call.
        // This prevents the ReferenceError because onGooglePayLoaded is now guaranteed to exist globally.
        function onGooglePayLoaded() {
            // Set a flag indicating the GPay script has loaded.
            window.gpayScriptLoaded = true;
            // If the main app has already defined the handler, call it.
            if (window.gpayReadyHandler) {
                window.gpayReadyHandler();
            }
        }
    </script>
    <script async src="https://pay.google.com/gp/p/js/pay.js" onload="onGooglePayLoaded()"></script>

    <style>
        /* Custom Styles for the Shop */
        body {
            font-family: 'Poppins', sans-serif;
        }
        .nav-link {
            position: relative;
            transition: color 0.3s ease;
        }
        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            transition: width 0.3s ease;
        }
        .nav-link:hover {
            color: #d1d5db; /* A lighter gray for hover */
        }
        .nav-link:hover::after {
            width: 100%;
        }
        .product-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .filter-control {
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .filter-control:focus {
            border-color: #3b82f6; /* Blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            outline: none;
        }
        .loading-spinner {
            border: 4px solid #f3f4f6; /* gray-100 */
            border-top: 4px solid #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .star-rating .star {
            color: #d1d5db; /* gray-300 */
            font-size: 1.25rem;
        }
        .star-rating .star.filled {
            color: #f59e0b; /* amber-500 */
        }
        /* Custom scrollbar for modal content */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Make GPay button fill width */
        .gpay-button-container > div {
            width: 100%;
        }
    </style>
</head>
<body class="bg-white">

    <header id="main-header" class="sticky top-0 left-0 right-0 z-50 py-4 bg-gray-800 shadow-md">
        <nav class="container mx-auto px-6 flex justify-between items-center text-white">
            <ul class="hidden md:flex items-center space-x-8 text-sm font-bold tracking-wider">
                <li><a href="shop.html" class="nav-link">SHOP</a></li>
                <li><a href="index.html#services" class="nav-link">SERVICES</a></li>
                <li><a href="index.html#partners" class="nav-link">BRANDS</a></li>
            </ul>
            <div class="text-2xl font-black tracking-widest"><a href="index.html">Grand AC</a></div>
            <ul class="hidden md:flex items-center space-x-8 text-sm font-bold tracking-wider">
                <li><a href="#" class="nav-link">ABOUT</a></li>
                <li><a href="#contact" class="nav-link">CONTACT</a></li>
            </ul>
        </nav>
    </header>

    <section id="shop-section" class="py-16 sm:py-24">
        <div class="container mx-auto px-4">
            <div class="text-left mb-8">
                <h2 class="text-3xl font-bold text-gray-800">Shop Our Products</h2>
                <p class="text-gray-500 mt-1">Find the perfect AC for your space.</p>
            </div>

            <div id="filter-container" class="bg-white p-6 rounded-xl border border-gray-200 mb-12">
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <div><label for="filter-pk" class="font-semibold text-gray-700">PK Size</label><select id="filter-pk" class="filter-control mt-1 block w-full p-2 border border-gray-300 rounded-md"><option value="all">All</option><option value="0.5">1/2 PK</option><option value="0.75">3/4 PK</option><option value="1">1 PK</option><option value="1.5">1.5 PK</option><option value="2">2 PK</option></select></div>
                    <div><label for="filter-brand" class="font-semibold text-gray-700">Brand</label><select id="filter-brand" class="filter-control mt-1 block w-full p-2 border border-gray-300 rounded-md"><option value="all">All</option><option value="daikin">Daikin</option><option value="panasonic">Panasonic</option><option value="sharp">Sharp</option><option value="lg">LG</option></select></div>
                    <div><label for="filter-tech" class="font-semibold text-gray-700">Technology</label><select id="filter-tech" class="filter-control mt-1 block w-full p-2 border border-gray-300 rounded-md"><option value="all">All</option><option value="standard">Standard</option><option value="inverter">Inverter</option><option value="low-watt">Low Watt</option></select></div>
                    <div><label for="filter-type" class="font-semibold text-gray-700">AC Type</label><select id="filter-type" class="filter-control mt-1 block w-full p-2 border border-gray-300 rounded-md"><option value="all">All</option><option value="split">Wall Mounted Split</option><option value="cassette">Cassette</option><option value="floor">Floor Standing</option></select></div>
                    <div><label for="sort-by" class="font-semibold text-gray-700">Sort By</label><select id="sort-by" class="filter-control mt-1 block w-full p-2 border border-gray-300 rounded-md"><option value="default">Default</option><option value="price-asc">Price: Low to High</option><option value="price-desc">Price: High to Low</option><option value="name-asc">Brand: A-Z</option><option value="name-desc">Brand: Z-A</option></select></div>
                </div>
            </div>

            <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Products will be rendered here by JavaScript -->
            </div>
            <div id="loading-indicator" class="text-center py-12">
                <div class="loading-spinner mx-auto"></div>
                <p class="mt-4 text-gray-600">Loading Products...</p>
            </div>
        </div>
    </section>
    
    <div id="quick-view-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <!-- Modal content will be injected here by JavaScript -->
    </div>

    <!-- Main Application Script -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyATtJOJkurwsx6G7dUj4qZi95v1XNLujfg",
            authDomain: "grand-ac-ca90f.firebaseapp.com",
            projectId: "grand-ac-ca90f",
            storageBucket: "grand-ac-ca90f.firebasestorage.app",
            messagingSenderId: "279069082013",
            appId: "1:279069082013:web:7d13d6faf1ce1d1953af74",
            measurementId: "G-0C7EKDCYNE"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allProducts = [];
        let paymentsClient;

        // --- GOOGLE PAY CONFIGURATION ---
        const baseRequest = {
            apiVersion: 2,
            apiVersionMinor: 0
        };
        const allowedCardNetworks = ["AMEX", "DISCOVER", "JCB", "MASTERCARD", "VISA"];
        const allowedCardAuthMethods = ["PAN_ONLY", "CRYPTOGRAM_3DS"];
        const tokenizationSpecification = {
            type: 'PAYMENT_GATEWAY',
            parameters: {
                'gateway': 'example',
                'gatewayMerchantId': 'exampleGatewayMerchantId'
            }
        };
        const baseCardPaymentMethod = {
            type: 'CARD',
            parameters: {
                allowedAuthMethods: allowedCardAuthMethods,
                allowedCardNetworks: allowedCardNetworks
            }
        };
        const merchantInfo = {
            merchantId: 'BCR2DN4TTXYYZFCV', // Your LIVE merchant ID
            merchantName: 'Grand AC'
        };

        function getGooglePaymentDataRequest(product) {
            const paymentDataRequest = {...baseRequest };
            paymentDataRequest.allowedPaymentMethods = [baseCardPaymentMethod];
            paymentDataRequest.transactionInfo = {
                totalPriceStatus: 'FINAL',
                totalPrice: String(product.Price),
                currencyCode: 'IDR',
                countryCode: 'ID'
            };
            paymentDataRequest.merchantInfo = merchantInfo;
            return paymentDataRequest;
        }

        // This function will be called by the global onGooglePayLoaded function
        function initializeGPay() {
            // NOTE: Still using 'TEST' environment. Switch to 'PRODUCTION' when you are ready to go live with a real payment processor.
            paymentsClient = new google.payments.api.PaymentsClient({ environment: 'TEST' });
            const isReadyToPayRequest = {...baseRequest, allowedPaymentMethods: [baseCardPaymentMethod] };
            paymentsClient.isReadyToPay(isReadyToPayRequest)
                .then(function(response) {
                    if (response.result) {
                        // GPay is ready. If products are already loaded, re-render them to show the GPay button.
                        if (allProducts.length > 0) {
                            updateShopView();
                        }
                    }
                })
                .catch(function(err) {
                    console.error("Error checking GPay readiness:", err);
                });
        }

        function addGooglePayButton(product, containerId) {
            if (!paymentsClient) return;
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const button = paymentsClient.createButton({
                onClick: () => onGPayClicked(product),
                buttonType: 'buy',
                buttonSizeMode: 'fill',
            });
            container.innerHTML = ''; // Clear previous button if any
            container.appendChild(button);
        }

        function onGPayClicked(product) {
            const paymentDataRequest = getGooglePaymentDataRequest(product);
            paymentDataRequest.transactionInfo.displayItems = [{
                label: product.name,
                type: 'LINE_ITEM',
                price: String(product.Price),
            }];

            paymentsClient.loadPaymentData(paymentDataRequest)
                .then(function(paymentData) {
                    console.log('Payment successful', paymentData);
                    const modal = document.getElementById('quick-view-modal');
                    modal.innerHTML = `
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-8 text-center" onclick="event.stopPropagation()">
                            <h3 class="text-2xl font-bold text-green-600 mb-4">Payment Successful!</h3>
                            <p class="text-gray-600">Thank you for your purchase of ${product.name}.</p>
                            <button class="modal-close-btn mt-6 bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Close</button>
                        </div>
                    `;
                    modal.querySelector('.modal-close-btn').addEventListener('click', () => modal.style.display = 'none');
                    modal.style.display = 'flex';
                })
                .catch(function(err) {
                    console.error('Payment failed', err);
                });
        }
        
        // --- DATA FETCHING from FIRESTORE ---
        async function fetchAllProducts() {
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.style.display = 'block';
            try {
                const querySnapshot = await getDocs(collection(db, "products"));
                allProducts = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error fetching products from Firebase:", error);
                document.getElementById('product-grid').innerHTML = `<p class="col-span-full text-center text-red-500">Error loading products. Please check the connection and try again.</p>`;
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        // --- RENDERING LOGIC ---
        function renderProducts(productsToDisplay) {
            const productGrid = document.getElementById('product-grid');
            productGrid.innerHTML = ''; 

            if (productsToDisplay.length === 0) {
                productGrid.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">No products match the current filters.</p>`;
                return;
            }

            productsToDisplay.forEach(product => {
                const card = document.createElement('div');
                card.className = "product-card flex flex-col bg-white rounded-lg shadow-md border border-gray-200 p-4";
                card.dataset.id = product.id;
                
                card.innerHTML = `
                    <img src="${product.imageUrl || 'https://placehold.co/400x300/e2e8f0/94a3b8?text=No+Image'}" alt="${product.name}" class="w-full h-40 object-cover rounded-md mb-4" onerror="this.onerror=null;this.src='https://placehold.co/400x300/e2e8f0/94a3b8?text=No+Image';">
                    <div class="flex-grow">
                        <h3 class="font-bold text-gray-800">${product.name || 'No Name'}</h3>
                        <div class="star-rating my-2">${getStarHTML(product.rating)}</div>
                        <p class="text-lg font-semibold text-gray-900 mb-4">${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(product.Price || 0)}</p>
                    </div>
                    <div class="mt-auto pt-4 border-t border-gray-100">
                        <div id="gpay-card-container-${product.id}" class="gpay-button-container mb-2"></div>
                        <div class="flex justify-between items-center text-xs mt-3 text-gray-500">
                            <a href="#" data-product-id="${product.id}" class="quick-view-link font-semibold hover:text-blue-600">Quick View</a>
                            <div class="flex space-x-3">
                                <a href="${product.Tokopedia_Link || '#'}" target="_blank" class="hover:text-green-600 font-semibold ${!product.Tokopedia_Link ? 'hidden' : ''}">Tokopedia</a>
                                <a href="${product.Shopee_Link || '#'}" target="_blank" class="hover:text-orange-500 font-semibold ${!product.Shopee_Link ? 'hidden' : ''}">Shopee</a>
                            </div>
                        </div>
                    </div>
                `;
                productGrid.appendChild(card);
                addGooglePayButton(product, `gpay-card-container-${product.id}`);
            });
        }

        function getStarHTML(rating) {
            const fullStars = Math.floor(rating || 0);
            let starsHTML = '';
            for (let i = 0; i < 5; i++) {
                starsHTML += `<span class="star ${i < fullStars ? 'filled' : ''}">${i < fullStars ? '&#9733;' : '&#9734;'}</span>`;
            }
            return starsHTML;
        }

        // --- FILTERING & SORTING LOGIC ---
        function updateShopView() {
            const activeFilters = {
                pk: document.getElementById('filter-pk').value,
                brand: document.getElementById('filter-brand').value,
                tech: document.getElementById('filter-tech').value,
                type: document.getElementById('filter-type').value
            };
            const sortBy = document.getElementById('sort-by').value;

            let filtered = allProducts.filter(p => 
                (activeFilters.pk === 'all' || String(p.PK_Size) === activeFilters.pk) &&
                (activeFilters.brand === 'all' || p.brand === activeFilters.brand) &&
                (activeFilters.tech === 'all' || p.Technology === activeFilters.tech) &&
                (activeFilters.type === 'all' || p.Type === activeFilters.type)
            );

            filtered.sort((a, b) => {
                switch (sortBy) {
                    case 'price-asc': return a.Price - b.Price;
                    case 'price-desc': return b.Price - a.Price;
                    case 'name-asc': return a.name.localeCompare(b.name);
                    case 'name-desc': return b.name.localeCompare(a.name);
                    default: return 0;
                }
            });
            
            renderProducts(filtered);
        }

        // --- QUICK VIEW MODAL ---
        function openQuickView(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            const modal = document.getElementById('quick-view-modal');
            const descriptionHTML = window.marked ? marked.parse(product.Description || '') : (product.Description || '').replace(/\\n/g, '<br>');

            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl relative flex flex-col max-h-[90vh]" onclick="event.stopPropagation()">
                    <button class="modal-close-btn absolute top-3 right-4 text-gray-400 hover:text-gray-700 text-3xl z-10">&times;</button>
                    <div class="grid md:grid-cols-2 gap-8 p-8 overflow-hidden">
                        <div>
                            <img src="${product.imageUrl || 'https://placehold.co/400x300/e2e8f0/94a3b8?text=No+Image'}" alt="${product.name}" class="w-full h-auto object-cover rounded-lg" onerror="this.onerror=null;this.src='https://placehold.co/400x300/e2e8f0/94a3b8?text=No+Image';">
                        </div>
                        <div class="overflow-y-auto pr-4">
                            <h3 class="text-2xl font-bold">${product.name}</h3>
                            <div class="star-rating my-2">${getStarHTML(product.rating)}</div>
                            <p class="text-3xl font-bold text-blue-600 my-4">${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(product.Price)}</p>
                            <div class="text-gray-600 mb-6 prose prose-sm max-w-none">${descriptionHTML}</div>
                            
                            <div class="mt-6 space-y-3">
                                <div id="gpay-modal-container-${product.id}" class="gpay-button-container"></div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <a href="${product.Tokopedia_Link || '#'}" target="_blank" class="block w-full text-center bg-[#03ac0e] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#028a0b] transition-colors ${!product.Tokopedia_Link ? 'hidden' : ''}">Buy at Tokopedia</a>
                                    <a href="${product.Shopee_Link || '#'}" target="_blank" class="block w-full text-center bg-[#ee4d2d] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#d03f1e] transition-colors ${!product.Shopee_Link ? 'hidden' : ''}">Buy at Shopee</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
            modal.querySelector('.modal-close-btn').addEventListener('click', () => modal.style.display = 'none');
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
            // Add GPay button to the modal
            addGooglePayButton(product, `gpay-modal-container-${product.id}`);
        }
        
        // --- INITIALIZATION ---
        async function initializeShop() {
            document.querySelectorAll('.filter-control').forEach(el => {
                el.addEventListener('change', updateShopView);
            });
            
            document.getElementById('product-grid').addEventListener('click', function(event) {
                if (event.target.classList.contains('quick-view-link')) {
                    event.preventDefault();
                    const productId = event.target.dataset.productId;
                    openQuickView(productId);
                }
            });

            await fetchAllProducts();

            const urlParams = new URLSearchParams(window.location.search);
            const pkFromUrl = urlParams.get('pk');
            if (pkFromUrl) {
                const pkSelect = document.getElementById('filter-pk');
                if (pkSelect.querySelector(`option[value="${pkFromUrl}"]`)) {
                    pkSelect.value = pkFromUrl;
                }
            }

            updateShopView(); 
        }
        
        // Expose the GPay initializer to the global scope so onGooglePayLoaded can call it.
        window.gpayReadyHandler = initializeGPay;
        // If the GPay script has ALREADY loaded (before this script ran), initialize GPay now.
        if (window.gpayScriptLoaded) {
            window.gpayReadyHandler();
        }

        initializeShop();
    </script>
</body>
</html>
